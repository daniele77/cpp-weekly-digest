name: C++ Weekly Digest

on:
  schedule:
    - cron: "0 7 * * 1" # 08:00 CET
  workflow_dispatch:

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      # checkout repository
      - uses: actions/checkout@v4
      
      # setup python
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Install dependencies
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y pandoc

      # run the script
      - run: python src/main.py

      # upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: weekly-report
          path: weekly_report.md

      # Markdown â†’ HTML conversion
      - name: Convert Markdown to HTML
        run: |
            DATE=$(date '+%Y-%m-%d')
            pandoc weekly_report.md \
              --template=template.html \
              -V DATE="$DATE" \
              -s -c style.css \
              -o index.html
        
      # Publish on GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          user_name: github-actions
          user_email: github-actions@github.com
          commit_message: "Update C++ Weekly Digest"
